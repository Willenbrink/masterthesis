\section{Inference Rules}
\inference[T-TASK]{x:C; \mathit{ocap} \vdash t : \tau \\ \Gamma; a \vdash b : Q \vartriangleright \mathit{Box}[C]}{\Gamma; a \vdash \mathit{task}(b) \{x \Rightarrow t\} : Q \vartriangleright \mathit{Task}[C]}
\inference[]{}{}

\inference[T-ASYNC]{\mathit{Perm}[Q] \in \Gamma \\ \Gamma \setminus \mathit{Perm}[Q]; a \vdash s : \sigma \\ \Gamma; a \vdash x : Q \vartriangleright \mathit{Task}[C]}{\Gamma; a \vdash \mathit{async}(x) \{s\} : \bot}
\inference[]{}{}

\inference[T-FINISH]{\Gamma; a \vdash t : \tau}{\Gamma; a \vdash \mathit{finish} \{ t \} : null}
\inference[]{}{}

% We have two kind of frames: The normal stack frames (sframe) and finish frames (fframe). They take a number of arguments:
% s:aligned? OL:variable assignments m:term OP:Permissions Ol:label
\NewDocumentCommand{\sframe}{ s O{L} m O{P} O{l} }{\langle #2,\ \IfBooleanT{#1}{&&} #3,\ \IfBooleanT{#1}{&&} #4 \IfBooleanT{#1}{&&}\rangle^#5 \IfBooleanT{#1}{&&} }
%s:aligned? m:id
\NewDocumentCommand{\fframe}{ s m }{\IfBooleanT{#1}{&&} \langle \mathit{FINISH} #2 \rangle}

% We have three kinds of reductions: frame, stack and tasks. Each come with sensible defaults
\NewDocumentCommand{\reducframe}{m m}{%
  \begin{alignedat}{7}
    H, &#1\\\rightarrow\ H, &#2
  \end{alignedat}%
}
\NewDocumentCommand{\reducstack}{m O{FS} m O{FS}}{%
  \begin{alignedat}{7}
    H, &#1 \circ #2\\\twoheadrightarrow\ H, &#3 \circ #4
  \end{alignedat}%
}
\NewDocumentCommand{\reductasks}{m O{TS} m O{TS}}{%
  \begin{alignedat}{7}
    H, &\{#1\} && \uplus #2\\\leadsto\ H, &\{#3\} && \uplus #4
  \end{alignedat}%
}
\NewDocumentCommand{\reducasync}{m m}{%
  \begin{alignedat}{7}
    H, & #1 \\\leadsto\ H, & #2
  \end{alignedat}%
}




\inference[E-TASK]{L(b') = b(o, p)}{%
  \reductasks{%
      (f, \sframe*{%
        let\ x = \mathit{task}(b')\{x \Rightarrow t\} in\ s%
      })%
  }{%
      (f, \sframe*[L[x \rightarrow \mathit{task}(b(o,p),t)]]{%
        s
      })%
  }%
}
\inference[]{}{}

\inference[E-ASYNC]{%
  L(y) = \mathit{task}(b(o,p),t)\\
  p \in P\\
  T_1 = (f, \sframe{s}[P][\epsilon])\\
  T_2 = (f, \sframe[[x \rightarrow o]]{t}[\emptyset][\epsilon])\\
}{%
  \reducasync{
    \{(f,%
      \sframe{\mathit{async}(y)\{s\}} \circ FS
    )\} && \uplus TS%
    }{
    \{ T_1, T_2 \} && \uplus TS%
    }
}
\inference[]{}{}

\inference[E-FINISH1]{%
  T = (f', \sframe{t}[P][\epsilon])\\
  f' \mathit{fresh}\\
}{%
  \reductasks{%
    (f,%
      \sframe{ \mathit{let}\ x = \mathit{finish} \{\ t\ \}\ \mathit{in}\ s} \circ FS%
    )
  }{%
    (f,%
      \fframe{f'} \circ \sframe[L[x\rightarrow \mathit{null}]]{s} \circ FS%
    )
  }[\{T\} \uplus TS]
}
\inference[]{}{}

\inference[E-FINISH2]{%
  \nexists (f', FS) \in TS
}{%
  \reductasks{%
    (f, \fframe{f'} \circ FS )%
  }{%
    (f, FS )%
  }
}
\inference[]{}{}

\inference[E-TASK-DONE]{}{
  H,\epsilon \uplus TS \leadsto TS
}
